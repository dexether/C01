<?php

// For Connection

include_once ("$_SERVER[DOCUMENT_ROOT]/includes/functions.php");
include_once ("$_SERVER[DOCUMENT_ROOT]/classes/Manager.class.php");

// Get META Database Where Enabled

$get_meta = "SELECT * FROM cabinet.mt_database WHERE enabled ='yes' ORDER BY alias ASC";
$get_meta_array = $DB->execresultset($get_meta);
$metas = array();
foreach ($get_meta_array as $m) {
  $metas[] = $m['mt4dt'];
}

    for ($i=0; $i < count($metas) ; $i++)
    { 
        
            $array_all = array ();
            $get_data = "SELECT LOGIN, PROFIT, DEPOSIT, PROFIT_CLOSED, TIME, LEFT(TIME, 10) AS TIME2 FROM ".$metas[$i].".mt4_daily WHERE STAT_NTR = '0' ORDER BY LOGIN ASC LIMIT 0,100";
            $get_data_array = $DB->execresultset ( $get_data );
            foreach ( $get_data_array as $row ) {
              $array_all [] = $row;
            }

            // cek Apakah data masih ada  ?
            if (count($array_all) > 0)
            {
                $array_prev = array ();
                foreach ( $array_all as $row ) {
                $LOGIN = $row ['LOGIN'];
                $DEPOSIT = $row ['DEPOSIT'];
                $PROFIT = $row ['PROFIT'];
                $PROFIT_CLOSED = $row ['PROFIT_CLOSED'];
                $NOW_TIMES = $row ['TIME2'];
                
                $get_prev_data = "SELECT LOGIN, PROFIT, LEFT(TIME, 10) AS TIME2 FROM ".$metas[$i].".mt4_daily WHERE LOGIN = '$LOGIN' AND LEFT(TIME, 10) < '$NOW_TIMES' ORDER BY TIME DESC LIMIT 0,1";
                
                $get_prev_data_array = $DB->execresultset ( $get_prev_data );
                
                foreach ( $get_data_array as $row1 )
                {
                  $PREV_TIME2 = $row1 ['TIME2'];
                  $PREV_PROFIT = $row1 ['PROFIT'];
                }
                {
                }
                $updates [] = array (
                    'LOGIN' => $LOGIN,
                    'TIME' => $NOW_TIMES,
                    'PREV_TIME' => $PREV_TIME2,
                    'PROFIT' => $PROFIT,
                    'PREV_PROFIT' => $PREV_PROFIT,
                    'DEPOSIT' => $DEPOSIT,
                    'PROFIT_CLOSED' => $PROFIT_CLOSED,
                    'NTR' => $DEPOSIT + $PROFIT_CLOSED + $PROFIT - $PREV_PROFIT 
                );
              }
              foreach ( $updates as $u ) {
                
                $DB->execonly("UPDATE ".$metas[$i].".mt4_daily SET NTR = '" . $u ['NTR'] . "', PREV_PROFIT = '" . $u ['PREV_PROFIT'] . "', STAT_NTR = '1' WHERE LOGIN = '".$u['LOGIN']."' AND LEFT(TIME, 10) = '".$u['TIME']."' ");
                // echo "UPDATE ".$metas[$i].".mt4_daily SET NTR = '" . $u ['NTR'] . "', PREV_PROFIT = '" . $u ['PREV_PROFIT'] . "', STAT_NTR = '1' WHERE LOGIN = '".$u['LOGIN']."' AND LEFT(TIME, 10) = '".$u['TIME']."'"."<br>";
              }
          }else{           
          echo "Data Habis";
          }
    }
    echo "Sukses UPDATE, halaman akan restart 5 detik ";
?>
<meta http-equiv="refresh" content="6">

