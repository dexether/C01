<?php
tradeLogs('START');
include_once "$_SERVER[DOCUMENT_ROOT]/includes/functions.php";
include_once "$_SERVER[DOCUMENT_ROOT]/classes/Manager.class.php";
include_once "includes/wr_tools.php";
$var_to_pass = null;
global $user;
global $template;
global $themonth;
global $mysql;
global $DB;
/*
if (isset($user)) {
$user;
}
$user = $_SESSION['user'];
$template->assign("user", $user);
 */
/*==============================
=            Coding            =
==============================*/

// $source = array('askap_source_mini', 'askap_source_reguler');

$query = "SELECT id, ACCNO, mt4login FROM mlm2";
$result = $DB->execresultset($query);
foreach ($result as $key => $value) {
	$query = "SELECT id FROM mlm2 WHERE ACCNO = '$value[ACCNO]' AND mt4login = '$value[mt4login]'";
	$hasil = $DB->execresultset($query);
	$data = array();
	foreach ($hasil as $row) {
		$data[] = $row;
	}
	if (count($data) > 1) {
		$delete = "DELETE FROM mlm2 WHERE id = '".$data[0]['id']."'";
		$DB->execonly($delete);
	}
	// var_dump($delete);
}



function check_account($update_tradeby, $last)
{
    global $DB;
    //$waktucheck1 = date('ymdH'); //2014 Aug 21 21:03:55
    $waktucheck1 = date('ymdH', strtotime('-1 hour'));
    $query       = "select * from mlm where ACCNO  like ('$waktucheck1%') order by ACCNO desc limit 0,1";
    //tradeLogMMNewLevel("MM_New_Level-378:".$query);
    $lastACCNO = 0;
    $rows      = $DB->execresultset($query);
    foreach ($rows as $row) {
        $lastACCNO = $row['ACCNO'];
    }
    $val1 = strlen($lastACCNO); //150403110000001
    $val2 = substr($lastACCNO, 8, $val1);
    //tradeLogMMNewLevel("MM_New_Level-386-Val1;".$val1.";Val2::".$val2);
    $val3 = intval($val2);
    //tradeLogMMNewLevel("MM_New_Level-239-Va32::".$val3);
    if ($last == '0') {
        $last = $val2 + 1;
    } else {
        $last = $last + 1;
    }

    //tradeLogMMNewLevel("MM_New_Level-241-Last:".$last);

    $account_name_check = $waktucheck1 . $last;
    //tradeLogMMNewLevel("MM_New_Level-397:".$account_name_check);//MM_New_Level-246:A000001

    $query = "select * from mlm where ACCNO  = '$account_name_check'";
    //tradeLogMMNewLevel("MM_New_Level-399-Query:".$query);//Query
    $is_accountname_already_taken = "no";
    $rows                         = $DB->execresultset($query);
    foreach ($rows as $row) {
        $lastACCNO                    = $row['ACCNO'];
        $is_accountname_already_taken = "yes";
    }

    $query = "select * from client_accounts where accountname='$account_name_check'";
    //tradeLogMMNewLevel("mm_new_level-301-query:" . $query);
    $rows = $DB->execresultset($query);
    foreach ($rows as $row) {
        $lastACCNO                    = $row['accountname'];
        $is_accountname_already_taken = "yes";
    }

    if ($is_accountname_already_taken == "yes") {
        $accountname = check_account($update_tradeby, $last);
    } else {
        $accountname = $account_name_check;
    }
    return $accountname;
}

function tradeLogs($msg)
{
    $fp      = fopen("trader.log", "a");
    $logdate = date("Y-m-d H:i:s => ");
    $msg     = preg_replace("/\s+/", " ", $msg);
    fwrite($fp, $logdate . $msg . "\n");
    fclose($fp);
    return;
}
function checkmlm($aecode, $upline_aecode)
{
    global $DB;
    $output = array();
    $query  = "SELECT
  client_accounts.`accountname`
FROM
  client_accounts,
  client_aecode,
  mlm
WHERE client_accounts.`aecodeid` = client_aecode.`aecodeid`
  AND client_accounts.`accountname` = mlm.`ACCNO`
  AND client_aecode.`aecode` = '$upline_aecode'";
    $result = $DB->execresultset($query);
    $upline = 0;
    foreach ($result as $key => $value) {
        $upline = $value['accountname'];
    }

    $query = "SELECT
  client_accounts.`accountname`
FROM
  client_accounts,
  client_aecode,
  mlm
WHERE client_accounts.`aecodeid` = client_aecode.`aecodeid`
  AND client_accounts.`accountname` = mlm.`ACCNO`
  AND client_aecode.`aecode` = '$aecode'
  AND mlm.Upline  = '$upline'";
    $result          = $DB->execresultset($query);
    $output['valid'] = false;
    foreach ($result as $key => $value) {
        $output['valid']       = true;
        $output['accountname'] = $value['accountname'];
    }
    return $output;
}
